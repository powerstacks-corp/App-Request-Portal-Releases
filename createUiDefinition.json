{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": true,
      "basics": {
        "description": "Deploy the **App Request Portal** - a self-service portal for users to request Intune-managed applications.\n\n**Prerequisites:**\n- Two Azure AD App Registrations (API and Frontend)\n- Azure AD tenant with Intune\n\nSee the [documentation](https://github.com/PowerStacks-BI/AppRequestPortal) for setup instructions.",
        "location": {
          "label": "Region",
          "allowedValues": [],
          "visible": true
        },
        "resourceGroup": {
          "allowExisting": false
        }
      }
    },
    "basics": [],
    "steps": [
      {
        "name": "authentication",
        "label": "Authentication",
        "elements": [
          {
            "name": "authInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Enter the Azure AD App Registration details. You need two app registrations: one for the API (with client secret) and one for the Frontend SPA."
            }
          },
          {
            "name": "tenantId",
            "type": "Microsoft.Common.TextBox",
            "label": "Azure AD Tenant ID",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Your Azure AD tenant ID (found in Azure AD > Overview)",
            "constraints": {
              "required": true,
              "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID"
            }
          },
          {
            "name": "apiClientId",
            "type": "Microsoft.Common.TextBox",
            "label": "API Client ID",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Application (client) ID of the API app registration",
            "constraints": {
              "required": true,
              "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID"
            }
          },
          {
            "name": "apiClientSecret",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "API Client Secret"
            },
            "toolTip": "Client secret from the API app registration",
            "constraints": {
              "required": true
            },
            "options": {
              "hideConfirmation": true
            }
          },
          {
            "name": "frontendClientId",
            "type": "Microsoft.Common.TextBox",
            "label": "Frontend Client ID",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Application (client) ID of the Frontend SPA app registration",
            "constraints": {
              "required": true,
              "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID"
            }
          }
        ]
      },
      {
        "name": "database",
        "label": "Database",
        "elements": [
          {
            "name": "dbInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure the SQL Server credentials. These will be used to create a new Azure SQL Database."
            }
          },
          {
            "name": "sqlAdminLogin",
            "type": "Microsoft.Common.TextBox",
            "label": "SQL Admin Username",
            "defaultValue": "sqladmin",
            "toolTip": "Administrator username for the SQL Server",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z][a-zA-Z0-9]{2,127}$",
              "validationMessage": "Must start with a letter and be 3-128 characters (letters and numbers only)"
            }
          },
          {
            "name": "sqlAdminPassword",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "SQL Admin Password",
              "confirmPassword": "Confirm Password"
            },
            "toolTip": "Password must be at least 12 characters with uppercase, lowercase, number, and special character",
            "constraints": {
              "required": true,
              "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{12,}$",
              "validationMessage": "Password must be at least 12 characters with uppercase, lowercase, number, and special character"
            }
          }
        ]
      },
      {
        "name": "authorization",
        "label": "Authorization (Optional)",
        "elements": [
          {
            "name": "authzInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optionally restrict access using Azure AD security groups. Leave empty to allow all authenticated users."
            }
          },
          {
            "name": "adminGroupId",
            "type": "Microsoft.Common.TextBox",
            "label": "Admin Group ID (Optional)",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Azure AD Group Object ID for administrators. Leave empty to allow all authenticated users admin access.",
            "constraints": {
              "required": false,
              "regex": "^$|^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID or empty"
            }
          },
          {
            "name": "approverGroupId",
            "type": "Microsoft.Common.TextBox",
            "label": "Approver Group ID (Optional)",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Azure AD Group Object ID for approvers. Leave empty to allow all authenticated users to approve.",
            "constraints": {
              "required": false,
              "regex": "^$|^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID or empty"
            }
          }
        ]
      },
      {
        "name": "email",
        "label": "Email (Optional)",
        "elements": [
          {
            "name": "emailInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optionally configure email notifications. Requires Mail.Send permission on the API app registration."
            }
          },
          {
            "name": "emailSendAsUserId",
            "type": "Microsoft.Common.TextBox",
            "label": "Send As User ID (Optional)",
            "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "toolTip": "Azure AD User Object ID to send emails as. Leave empty to disable email notifications.",
            "constraints": {
              "required": false,
              "regex": "^$|^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
              "validationMessage": "Must be a valid GUID or empty"
            }
          },
          {
            "name": "emailFromAddress",
            "type": "Microsoft.Common.TextBox",
            "label": "From Email Address (Optional)",
            "placeholder": "noreply@yourdomain.com",
            "toolTip": "Email address shown in the From field. Should match the SendAsUserId's mailbox.",
            "constraints": {
              "required": false,
              "regex": "^$|^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
              "validationMessage": "Must be a valid email address or empty"
            }
          }
        ]
      },
      {
        "name": "advanced",
        "label": "Advanced (Optional)",
        "elements": [
          {
            "name": "advancedInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure App Service Plan size and resiliency options. Default settings are recommended for most deployments."
            }
          },
          {
            "name": "appServicePlanSku",
            "type": "Microsoft.Common.DropDown",
            "label": "App Service Plan Size",
            "defaultValue": "B2 - Basic (Recommended for small deployments)",
            "toolTip": "Select the App Service Plan size. Standard or Premium recommended for production.",
            "constraints": {
              "required": true,
              "allowedValues": [
                { "label": "B1 - Basic Small", "value": "B1" },
                { "label": "B2 - Basic (Recommended for small deployments)", "value": "B2" },
                { "label": "B3 - Basic Large", "value": "B3" },
                { "label": "S1 - Standard Small", "value": "S1" },
                { "label": "S2 - Standard (Recommended for production)", "value": "S2" },
                { "label": "S3 - Standard Large", "value": "S3" },
                { "label": "P1v3 - Premium Small", "value": "P1v3" },
                { "label": "P2v3 - Premium (High availability)", "value": "P2v3" },
                { "label": "P3v3 - Premium Large", "value": "P3v3" }
              ]
            }
          },
          {
            "name": "appServicePlanInstanceCount",
            "type": "Microsoft.Common.Slider",
            "label": "Instance Count",
            "subLabel": "instances",
            "defaultValue": 1,
            "toolTip": "Number of App Service instances. 2+ recommended for high availability in production.",
            "constraints": {
              "required": true
            },
            "min": 1,
            "max": 10,
            "showStepMarkers": true
          },
          {
            "name": "enableAutoHeal",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Auto-Heal (Recommended)",
            "defaultValue": true,
            "toolTip": "Automatically restart the app when issues are detected. Free feature, recommended for all deployments."
          },
          {
            "name": "enableHealthCheck",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Health Check (Recommended)",
            "defaultValue": true,
            "toolTip": "Monitor app health and automatically route traffic away from unhealthy instances. Free feature, recommended for all deployments."
          }
        ]
      }
    ],
    "outputs": {
      "environmentName": "prod",
      "location": "[location()]",
      "tenantId": "[steps('authentication').tenantId]",
      "apiClientId": "[steps('authentication').apiClientId]",
      "apiClientSecret": "[steps('authentication').apiClientSecret]",
      "frontendClientId": "[steps('authentication').frontendClientId]",
      "sqlAdminLogin": "[steps('database').sqlAdminLogin]",
      "sqlAdminPassword": "[steps('database').sqlAdminPassword]",
      "adminGroupId": "[steps('authorization').adminGroupId]",
      "approverGroupId": "[steps('authorization').approverGroupId]",
      "emailSendAsUserId": "[steps('email').emailSendAsUserId]",
      "emailFromAddress": "[steps('email').emailFromAddress]",
      "appServicePlanSku": "[steps('advanced').appServicePlanSku]",
      "appServicePlanInstanceCount": "[steps('advanced').appServicePlanInstanceCount]",
      "enableAutoHeal": "[steps('advanced').enableAutoHeal]",
      "enableHealthCheck": "[steps('advanced').enableHealthCheck]"
    }
  }
}
