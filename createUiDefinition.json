{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": true,
      "basics": {
        "description": "Deploy the **App Request Portal** - a self-service portal for users to request Intune-managed applications.\n\n**Prerequisites:**\n- Two Entra ID App Registrations (API and Frontend)\n- Entra ID tenant with Intune\n\nSee the [documentation](https://github.com/PowerStacks-BI/AppRequestPortal) for setup instructions.",
        "location": {
          "label": "Region",
          "allowedValues": [],
          "visible": true
        },
        "resourceGroup": {
          "allowExisting": false
        }
      }
    },
    "basics": [],
    "steps": [
      {
        "name": "authentication",
        "label": "Entra ID Configuration",
        "elements": [
          {
            "name": "authInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Enter the values from your Entra ID app registrations. You need two apps: an API application (backend) and a Frontend application (SPA). The tenant ID is automatically detected from your current session."
            }
          },
          {
            "name": "apiSection",
            "type": "Microsoft.Common.Section",
            "label": "API Application (Backend)",
            "elements": [
              {
                "name": "apiClientId",
                "type": "Microsoft.Common.TextBox",
                "label": "API Client ID",
                "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
                "toolTip": "Application (client) ID of the API app registration",
                "constraints": {
                  "required": true,
                  "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
                  "validationMessage": "Must be a valid GUID"
                }
              },
              {
                "name": "apiClientSecret",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "API Client Secret"
                },
                "toolTip": "Client secret from the API app registration",
                "constraints": {
                  "required": true
                },
                "options": {
                  "hideConfirmation": true
                }
              }
            ]
          },
          {
            "name": "frontendSection",
            "type": "Microsoft.Common.Section",
            "label": "Frontend Application (SPA)",
            "elements": [
              {
                "name": "frontendClientId",
                "type": "Microsoft.Common.TextBox",
                "label": "Frontend Client ID",
                "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
                "toolTip": "Application (client) ID of the Frontend SPA app registration",
                "constraints": {
                  "required": true,
                  "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
                  "validationMessage": "Must be a valid GUID"
                }
              }
            ]
          }
        ]
      },
      {
        "name": "database",
        "label": "SQL Database",
        "elements": [
          {
            "name": "dbInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure the SQL Server credentials. These will be used to create a new Azure SQL Database."
            }
          },
          {
            "name": "sqlAdminLogin",
            "type": "Microsoft.Common.TextBox",
            "label": "SQL Admin Username",
            "defaultValue": "sqladmin",
            "toolTip": "Administrator username for the SQL Server",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z][a-zA-Z0-9]{2,127}$",
              "validationMessage": "Must start with a letter and be 3-128 characters (letters and numbers only)"
            }
          },
          {
            "name": "sqlAdminPassword",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "SQL Admin Password",
              "confirmPassword": "Confirm Password"
            },
            "toolTip": "Password must be at least 12 characters with uppercase, lowercase, number, and special character",
            "constraints": {
              "required": true,
              "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{12,}$",
              "validationMessage": "Password must be at least 12 characters with uppercase, lowercase, number, and special character"
            }
          }
        ]
      },
      {
        "name": "teamsBot",
        "label": "Teams Bot (Optional)",
        "elements": [
          {
            "name": "botInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optionally deploy a Teams Bot for proactive notifications (approval requests, status updates). This requires a separate Entra ID app registration for the bot. You can skip this and configure it later from Admin Settings."
            }
          },
          {
            "name": "enableTeamsBot",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Teams Bot Notifications"
          },
          {
            "name": "teamsBotSection",
            "type": "Microsoft.Common.Section",
            "label": "Bot App Registration",
            "visible": "[steps('teamsBot').enableTeamsBot]",
            "elements": [
              {
                "name": "botSetupInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Create a separate Entra ID app registration for the bot (single-tenant, no redirect URIs needed). The ARM template will create the Azure Bot resource and Teams channel automatically."
                }
              },
              {
                "name": "teamsBotAppId",
                "type": "Microsoft.Common.TextBox",
                "label": "Bot App ID",
                "placeholder": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
                "toolTip": "Application (client) ID of the bot's Entra ID app registration",
                "constraints": {
                  "required": true,
                  "regex": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
                  "validationMessage": "Must be a valid GUID"
                }
              },
              {
                "name": "teamsBotAppPassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Bot Client Secret"
                },
                "toolTip": "Client secret from the bot's Entra ID app registration",
                "constraints": {
                  "required": true
                },
                "options": {
                  "hideConfirmation": true
                }
              }
            ]
          }
        ]
      },
      {
        "name": "advanced",
        "label": "Advanced",
        "elements": [
          {
            "name": "advancedInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure App Service Plan size and resiliency options. Default settings are recommended for most deployments."
            }
          },
          {
            "name": "releaseChannel",
            "type": "Microsoft.Common.DropDown",
            "label": "Release Channel",
            "defaultValue": "Stable (Recommended)",
            "toolTip": "Choose which version to deploy. Stable is recommended for production, Staging includes the latest features and previews.",
            "constraints": {
              "required": true,
              "allowedValues": [
                { "label": "Stable (Recommended)", "value": "Latest" },
                { "label": "Staging (Preview Features)", "value": "Staging" }
              ]
            }
          },
          {
            "name": "appServicePlanSku",
            "type": "Microsoft.Common.DropDown",
            "label": "App Service Plan Size",
            "defaultValue": "B2 - Basic (Recommended for small deployments)",
            "toolTip": "Select the App Service Plan size. Standard or Premium recommended for production.",
            "constraints": {
              "required": true,
              "allowedValues": [
                { "label": "B1 - Basic Small", "value": "B1" },
                { "label": "B2 - Basic (Recommended for small deployments)", "value": "B2" },
                { "label": "B3 - Basic Large", "value": "B3" },
                { "label": "S1 - Standard Small", "value": "S1" },
                { "label": "S2 - Standard (Recommended for production)", "value": "S2" },
                { "label": "S3 - Standard Large", "value": "S3" },
                { "label": "P1v3 - Premium Small", "value": "P1v3" },
                { "label": "P2v3 - Premium (High availability)", "value": "P2v3" },
                { "label": "P3v3 - Premium Large", "value": "P3v3" }
              ]
            }
          },
          {
            "name": "appServicePlanInstanceCount",
            "type": "Microsoft.Common.Slider",
            "label": "Instance Count",
            "subLabel": "instances",
            "defaultValue": 1,
            "toolTip": "Number of App Service instances. 2+ recommended for high availability in production.",
            "constraints": {
              "required": true
            },
            "min": 1,
            "max": 10,
            "showStepMarkers": true
          },
          {
            "name": "enableAutoHeal",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Auto-Heal (Recommended)",
            "defaultValue": true,
            "toolTip": "Automatically restart the app when issues are detected. Free feature, recommended for all deployments."
          },
          {
            "name": "enableHealthCheck",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Health Check (Recommended)",
            "defaultValue": true,
            "toolTip": "Monitor app health and automatically route traffic away from unhealthy instances. Free feature, recommended for all deployments."
          }
        ]
      }
    ],
    "outputs": {
      "environmentName": "prod",
      "location": "[location()]",
      "apiClientId": "[steps('authentication').apiSection.apiClientId]",
      "apiClientSecret": "[steps('authentication').apiSection.apiClientSecret]",
      "frontendClientId": "[steps('authentication').frontendSection.frontendClientId]",
      "sqlAdminLogin": "[steps('database').sqlAdminLogin]",
      "sqlAdminPassword": "[steps('database').sqlAdminPassword]",
      "releaseChannel": "[steps('advanced').releaseChannel]",
      "appServicePlanSku": "[steps('advanced').appServicePlanSku]",
      "appServicePlanInstanceCount": "[steps('advanced').appServicePlanInstanceCount]",
      "enableAutoHeal": "[steps('advanced').enableAutoHeal]",
      "enableHealthCheck": "[steps('advanced').enableHealthCheck]",
      "enableTeamsBot": "[steps('teamsBot').enableTeamsBot]",
      "teamsBotAppId": "[if(steps('teamsBot').enableTeamsBot, steps('teamsBot').teamsBotSection.teamsBotAppId, '')]",
      "teamsBotAppPassword": "[if(steps('teamsBot').enableTeamsBot, steps('teamsBot').teamsBotSection.teamsBotAppPassword, '')]"
    }
  }
}
